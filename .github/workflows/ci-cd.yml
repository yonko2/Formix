name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    types: [ready_for_review]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: Install PHP Dependencies
      run: composer install --prefer-dist --no-progress

    - name: Run PHP Linting (PHPCS)
      run: composer lint

    - name: Build Docker Image
      run: docker build -t formix-app:latest .

    - name: Start Services
      if: github.event_name != 'pull_request' || !github.event.pull_request.draft
      run: docker compose up -d

    - name: Wait for MySQL
      if: github.event_name != 'pull_request' || !github.event.pull_request.draft
      run: sleep 30

    - name: Setup Node.js
      if: github.event_name != 'pull_request' || !github.event.pull_request.draft
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install Dependencies
      if: github.event_name != 'pull_request' || !github.event.pull_request.draft
      run: npm install

    - name: Install Playwright Browsers
      if: github.event_name != 'pull_request' || !github.event.pull_request.draft
      run: npx playwright install --with-deps

    - name: Run Playwright Tests
      if: github.event_name != 'pull_request' || !github.event.pull_request.draft
      run: npx playwright test

    - name: Stop Services
      if: always()
      run: docker compose down

  deploy:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Kubernetes
        run: |
          echo "Deploying to Kubernetes..."
          # kubectl apply -f k8s/
          echo "Manifests applied."
